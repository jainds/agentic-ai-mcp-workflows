# Insurance AI PoC - Kubernetes-Native A2A/MCP Microservices Architecture

## Overview

This project implements a sophisticated microservices architecture for AI agents using:
- **Google's Agent-to-Agent (A2A) Protocol** for inter-agent communication
- **Anthropic's Model Context Protocol (MCP)** for tool orchestration
- **OpenRouter API** for LLM integration with multiple models
- **Kubernetes-native deployment** with Helm charts
- **Real-time monitoring** with Prometheus/Grafana/Jaeger
- **OAuth2 security** for service authentication
- **Comprehensive testing strategy** with unit, integration, and e2e tests

## Architecture Components

### 1. Domain Agents (LLM-Powered)
- **Claims Agent**: Processes insurance claims with AI analysis and fraud detection
- **Support Agent**: Handles customer support requests with natural language understanding
- **Policy Agent**: Manages policy information with intelligent query processing

### 2. Technical Agents (MCP-Enabled)
- **Data Agent**: Provides data access and analytics via MCP tools
- **Notification Agent**: Handles alerts and communications
- **Integration Agent**: Manages third-party API integrations

### 3. Enterprise Mock APIs
- **Claims Service**: FastAPI service for claims CRUD operations
- **User Service**: User management and authentication
- **Policy Service**: Policy data management
- **Analytics Service**: Data analytics and reporting

### 4. UI Components
- **Streamlit Dashboard**: Interactive UI for agent communication
- **Agent Registry**: Visual agent discovery and monitoring
- **Real-time Flow Visualization**: Agent-to-agent communication tracking

## LLM Integration

### Supported Providers
- **OpenRouter** (recommended) - Access multiple models through one API
- **OpenAI** - Direct OpenAI API integration
- **Demo Mode** - For testing without API keys

### Available Models
- **Free Models**: Qwen 3, Microsoft MAI, Llama 3.2, Mistral 7B
- **Paid Models**: GPT-4, Claude 3.5 Sonnet, GPT-4 Mini

See [OpenRouter Setup Guide](docs/OPENROUTER_SETUP.md) for detailed configuration.

## Quick Start

### Prerequisites
- Docker Desktop or Rancher Desktop with Kubernetes enabled
- Helm 3.x installed
- kubectl configured for your cluster
- **Optional**: OpenRouter API key for LLM features

### Local Development Setup

1. **Clone and Setup**
```bash
git clone <repository>
cd insurance-ai-poc
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate
pip install -r requirements.txt
```

2. **Configure LLM Integration (Optional)**
```bash
# Copy environment template
cp .env.example .env

# Edit .env file with your OpenRouter API key
OPENROUTER_API_KEY=your-api-key-here
PRIMARY_MODEL=qwen/qwen3-30b-a3b:free
FALLBACK_MODEL=microsoft/mai-ds-r1:free
```

3. **Run Tests**
```bash
# Test basic functionality
source .venv/bin/activate
export PYTHONPATH=/path/to/insurance-ai-poc:$PYTHONPATH
python tests/test_openrouter_integration.py

# Test OpenRouter LLM integration
python tests/test_openrouter_llm.py
```

4. **Start Local Services**
```bash
# Start all services with Docker Compose
docker-compose up -d

# Or run individual components
python agents/domain/claims_agent.py
python agents/technical/data_agent.py
python ui/streamlit_app.py
```

5. **Deploy to Kubernetes**
```bash
# Install dependencies
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo add grafana https://grafana.github.io/helm-charts
helm repo update

# Deploy the application
./scripts/build-and-deploy.sh

# Access the UI
kubectl port-forward svc/insurance-ui 8501:8501 -n insurance-ai
```

### Access Points
- **Streamlit UI**: http://localhost:8501
- **Agent Registry**: http://localhost:5002
- **Grafana Dashboard**: http://localhost:3000 (admin/admin)
- **Prometheus**: http://localhost:9090

## Project Structure

```
insurance-ai-poc/
├── agents/                    # A2A Agent implementations
│   ├── domain/               # Domain-specific agents
│   │   ├── claims_agent.py
│   │   ├── support_agent.py
│   │   └── policy_agent.py
│   ├── technical/            # Technical capability agents
│   │   ├── data_agent.py
│   │   ├── notification_agent.py
│   │   └── integration_agent.py
│   └── shared/               # Shared agent utilities
│       ├── a2a_base.py
│       ├── mcp_base.py
│       └── auth.py
├── services/                 # FastAPI mock enterprise services
│   ├── claims_service/
│   ├── user_service/
│   ├── policy_service/
│   └── analytics_service/
├── ui/                       # Streamlit UI components
│   ├── streamlit_app.py
│   ├── agent_registry.py
│   └── components/
├── mcp/                      # MCP server implementations
│   ├── data_server.py
│   ├── notification_server.py
│   └── integration_server.py
├── k8s/                      # Kubernetes manifests
│   ├── charts/               # Helm charts
│   ├── monitoring/           # Prometheus/Grafana configs
│   └── security/             # OAuth2/RBAC configs
├── tests/                    # Comprehensive test suite
│   ├── unit/
│   ├── integration/
│   ├── contract/
│   └── e2e/
├── scripts/                  # Deployment and utility scripts
├── docs/                     # Architecture documentation
└── docker-compose.yml       # Local development setup
```

## Testing Strategy

### Unit Tests
```bash
pytest tests/unit/ -v --cov=agents --cov=services
```

### Integration Tests
```bash
pytest tests/integration/ -v
```

### Contract Tests
```bash
pytest tests/contract/ -v
```

### End-to-End Tests
```bash
pytest tests/e2e/ -v
```

### Load Testing
```bash
./scripts/load_test.sh
```

## Monitoring and Observability

### Metrics (Prometheus)
- Agent task processing rates
- A2A communication latencies
- MCP tool invocation success rates
- Service health and performance

### Tracing (Jaeger)
- Cross-service request flows
- Agent-to-agent communication paths
- MCP tool execution traces

### Dashboards (Grafana)
- Real-time agent activity
- System performance metrics
- Business KPIs and analytics

## Security

### OAuth2 Authentication
- Keycloak integration for identity management
- Service-to-service authentication with JWT
- Role-based access control (RBAC)

### Network Security
- TLS encryption for all communications
- Network policies for service isolation
- Secret management with Kubernetes secrets

## Development Guidelines

### Adding New Agents
1. Extend `agents/shared/a2a_base.py`
2. Implement required A2A endpoints
3. Add MCP tool integrations
4. Create Kubernetes manifests
5. Add comprehensive tests

### Creating MCP Tools
1. Use FastMCP framework
2. Define resources and tools
3. Implement proper error handling
4. Add authentication and authorization
5. Create integration tests

## Troubleshooting

### Common Issues
- **Agent Discovery**: Check Kubernetes DNS resolution
- **Authentication**: Verify OAuth2 token validity
- **Performance**: Monitor Prometheus metrics
- **Networking**: Check service mesh configuration

### Debug Commands
```bash
# Check agent status
kubectl get pods -l app=agents

# View logs
kubectl logs -l app=claims-agent -f

# Port forward for debugging
kubectl port-forward svc/claims-agent 8000:8000

# Run diagnostics
./scripts/diagnose.sh
```

## Contributing

1. Fork the repository
2. Create a feature branch
3. Add tests for new functionality
4. Ensure all tests pass
5. Submit a pull request

## License

MIT License - see LICENSE file for details 